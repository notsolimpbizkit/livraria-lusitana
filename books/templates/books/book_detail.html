{% extends 'base.html' %}
{% load static %}

{% block title %}{{ book.title }} - Livraria Lusitana{% endblock %}

{% block content %}
<div class="container my-5">
  <div class="row">
    <!-- Book cover and purchase options -->
    <div class="col-md-4">
      <div class="card border-0">
        {% if book.image %}
          <img src="{{ book.image.url }}" class="img-fluid rounded" alt="{{ book.title }}">
        {% else %}
          <img src="{% static 'images/book_placeholder.jpg' %}" class="img-fluid rounded" alt="{{ book.title }}">
        {% endif %}
        
        <div class="mt-3">
          <div class="d-grid gap-2">
            <button class="btn btn-primary btn-lg js-add-to-cart" data-book-id="{{ book.id }}">
              <i class="bi bi-cart-plus"></i> Adicionar ao Carrinho
            </button>
            
            {% if user.is_authenticated %}
            <button class="btn btn-outline-secondary js-add-to-wishlist" data-book-id="{{ book.id }}">
              <i class="bi bi-heart"></i> Adicionar aos Favoritos
            </button>
            {% endif %}
          </div>
          
          <!-- Stock information -->
          {% if book.stock > 10 %}
            <p class="text-success mt-3">
              <i class="bi bi-check-circle-fill"></i> Em estoque
            </p>
          {% elif book.stock > 0 %}
            <p class="text-warning mt-3">
              <i class="bi bi-exclamation-circle-fill"></i> Restam apenas {{ book.stock }} unidades
            </p>
          {% else %}
            <p class="text-danger mt-3">
              <i class="bi bi-x-circle-fill"></i> Fora de estoque
            </p>
          {% endif %}
        </div>
      </div>
    </div>
    
    <!-- Book details -->
    <div class="col-md-8">
      <h1 class="mb-2">{{ book.title }}</h1>
      <p class="text-muted mb-1">por <strong>{{ book.author }}</strong></p>
      
      <!-- Rating display -->
      <div class="mb-3">
        {% if book.avg_rating %}
          <div class="ratings">
            {% for i in "12345" %}
              {% if forloop.counter <= book.avg_rating|floatformat:"0" %}
                <i class="bi bi-star-fill text-warning"></i>
              {% else %}
                <i class="bi bi-star text-warning"></i>
              {% endif %}
            {% endfor %}
            <span class="ms-2">{{ book.avg_rating|floatformat:1 }} ({{ book.reviews.count }} avaliações)</span>
          </div>
        {% else %}
          <div class="ratings">
            <i class="bi bi-star text-muted"></i>
            <i class="bi bi-star text-muted"></i>
            <i class="bi bi-star text-muted"></i>
            <i class="bi bi-star text-muted"></i>
            <i class="bi bi-star text-muted"></i>
            <span class="ms-2 text-muted">Sem avaliações</span>
          </div>
        {% endif %}
      </div>
      
      <h2 class="fs-3 text-primary mb-3">{{ book.formatted_price }}</h2>
      
      <div class="mb-4">
        <h3 class="fs-5">Sinopse</h3>
        <p>{{ book.synopsis }}</p>
      </div>
      
      <!-- Book details in a responsive table -->
      <div class="mb-4">
        <h3 class="fs-5">Detalhes do Livro</h3>
        <div class="table-responsive">
          <table class="table table-striped">
            <tbody>
              <tr>
                <th style="width: 30%">Título</th>
                <td>{{ book.title }}</td>
              </tr>
              <tr>
                <th>Autor</th>
                <td>{{ book.author }}</td>
              </tr>
              <tr>
                <th>ISBN</th>
                <td>{{ book.isbn }}</td>
              </tr>
              <tr>
                <th>Editora</th>
                <td>{{ book.publisher }}</td>
              </tr>
              <tr>
                <th>Data de Publicação</th>
                <td>{{ book.publication_date|date:"d/m/Y" }}</td>
              </tr>
              <tr>
                <th>Idioma</th>
                <td>{{ book.language }}</td>
              </tr>
              <tr>
                <th>Páginas</th>
                <td>{{ book.pages }}</td>
              </tr>
              <tr>
                <th>Encadernação</th>
                <td>{{ book.binding_type }}</td>
              </tr>
              {% if book.dimensions %}
              <tr>
                <th>Dimensões</th>
                <td>{{ book.dimensions }}</td>
              </tr>
              {% endif %}
              <tr>
                <th>Categoria</th>
                <td>
                  <a href="{% url 'category_books' book.category.id %}">{{ book.category.name }}</a>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Reviews section -->
  <div class="row mt-5">
    <div class="col-12">
      <h3>Avaliações e Comentários</h3>
      
      {% if user.is_authenticated %}
        {% if user_review %}
          <!-- User has already reviewed this book -->
          <div class="alert alert-info mb-4">
            <p>Você já avaliou este livro. Você pode atualizar sua avaliação abaixo.</p>
          </div>
        {% endif %}
        
        <div class="card mb-4">
          <div class="card-body">
            <h5 class="card-title">{% if user_review %}Editar sua avaliação{% else %}Deixe sua avaliação{% endif %}</h5>
            <form method="post" action="{% url 'add_review' book.id %}">
              {% csrf_token %}
              
              <div class="mb-3">
                <label for="rating" class="form-label">Avaliação</label>
                <select class="form-select" name="rating" id="rating" required>
                  <option value="5" {% if user_review and user_review.rating == 5 %}selected{% endif %}>★★★★★ (5/5)</option>
                  <option value="4" {% if user_review and user_review.rating == 4 %}selected{% endif %}>★★★★☆ (4/5)</option>
                  <option value="3" {% if user_review and user_review.rating == 3 %}selected{% endif %}>★★★☆☆ (3/5)</option>
                  <option value="2" {% if user_review and user_review.rating == 2 %}selected{% endif %}>★★☆☆☆ (2/5)</option>
                  <option value="1" {% if user_review and user_review.rating == 1 %}selected{% endif %}>★☆☆☆☆ (1/5)</option>
                </select>
              </div>
              
              <div class="mb-3">
                <label for="review_text" class="form-label">Comentário</label>
                <textarea class="form-control" name="review_text" id="review_text" rows="3" required>{% if user_review %}{{ user_review.review_text }}{% endif %}</textarea>
              </div>
              
              <button type="submit" class="btn btn-primary">{% if user_review %}Atualizar Avaliação{% else %}Enviar Avaliação{% endif %}</button>
            </form>
          </div>
        </div>
      {% else %}
        <div class="alert alert-info mb-4">
          <p>Para deixar uma avaliação, por favor <a href="{% url 'login' %}?next={{ request.path }}">entre na sua conta</a> ou <a href="{% url 'register' %}">crie uma conta</a>.</p>
        </div>
      {% endif %}
      
      <!-- Display existing reviews -->
      {% if reviews %}
        <div class="card">
          <div class="card-header bg-light">
            <h5 class="mb-0">{{ reviews.count }} Avaliações</h5>
          </div>
          <div class="list-group list-group-flush">
            {% for review in reviews %}
              <div class="list-group-item">
                <div class="d-flex justify-content-between align-items-center">
                  <h6 class="mb-1">{{ review.user.username }}</h6>
                  <small class="text-muted">{{ review.created_at|date:"d/m/Y" }}</small>
                </div>
                <div class="mb-2 text-warning">
                  {% for i in "12345" %}
                    {% if forloop.counter <= review.rating %}
                      <i class="bi bi-star-fill"></i>
                    {% else %}
                      <i class="bi bi-star"></i>
                    {% endif %}
                  {% endfor %}
                </div>
                <p class="mb-1">{{ review.review_text }}</p>
              </div>
            {% endfor %}
          </div>
        </div>
      {% else %}
        <div class="alert alert-light">
          <p>Sem avaliações ainda. Seja o primeiro a avaliar!</p>
        </div>
      {% endif %}
    </div>
  </div>
  
  <!-- Related books section -->
  {% if related_books %}
  <div class="row mt-5">
    <div class="col-12">
      <h3>Livros Relacionados</h3>
    </div>
    
    {% for related in related_books %}
    <div class="col-md-3 mb-4">
      <div class="card h-100">
        <a href="{% url 'book_detail' related.id %}">
          {% if img %}
            <img src="{{ related.image.url }}" class="card-img-top book-cover" alt="{{ related.title }}">
          {% else %}
            <img src="{% static 'images/book_placeholder.jpg' %}" class="img-fluid rounded" alt="{{ book.title }}">
          {% endif %}
        </a>
        <div class="card-body d-flex flex-column">
          <h5 class="card-title">{{ related.title }}</h5>
          <p class="card-text text-muted">{{ related.author }}</p>
          <p class="card-text"><strong class="text-primary">{{ related.formatted_price }}</strong></p>
          <div class="mt-auto">
            <button class="btn btn-primary w-100 js-add-to-cart" data-book-id="{{ related.id }}">
              <i class="bi bi-cart-plus"></i> Adicionar
            </button>
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
  {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script type="module" src="{% static 'js/book.js' %}"></script>
{% endblock %}